add_exclude_to_updates_repo() {
    local repo_file="/etc/yum.repos.d/fedora-updates.repo"
    local backup_file="${repo_file}.bak"
    local exclude_line="exclude=kernel*"

    if [[ ! -f "$repo_file" ]]; then
        echo "Repository file not found: $repo_file"
        return 1
    fi

    # Create a backup of the original file
    cp "$repo_file" "$backup_file"
    echo "Backup created at: $backup_file"

    # Add exclude=kernel* directly after skip_if_unavailable=False in the [updates] section
    sed -i.bak -e '/^\[updates\]/,/^\[/{ /^\[updates\]/!{/^\[/b; /skip_if_unavailable=False/a\
'"$exclude_line"'
    }; }' "$repo_file"

    echo "Updated $repo_file with exclude=kernel* in the [updates] section."
}

update_kernel() {
    echo "Enabling the sentry/kernel-fsync COPR repository..."
    sudo dnf copr enable sentry/kernel-fsync -y

    echo "Updating the system with --refresh..."
    sudo dnf update --refresh -y
}

remove_exclude_from_updates_repo() {
    local repo_file="/etc/yum.repos.d/fedora-updates.repo"
    local backup_file="${repo_file}.bak"
    local exclude_line="exclude=kernel*"

    if [[ ! -f "$repo_file" ]]; then
        echo "Repository file not found: $repo_file"
        return 1
    fi

    # Create a backup of the original file
    cp "$repo_file" "$backup_file"
    echo "Backup created at: $backup_file"

    # Remove exclude=kernel* from the [updates] section
    sed -i.bak -e '/^\[updates\]/,/^\[/{ /^\[updates\]/!{/^\[/b; /'"$exclude_line"'/d;}; }' "$repo_file"

    echo "Removed $exclude_line from the [updates] section in $repo_file."
}

remove_copr_repo() {
    local repo_name="sentry/kernel-fsync"

    echo "Disabling the COPR repository: $repo_name..."
    sudo dnf copr disable "$repo_name" -y
    echo "Removed the COPR repository: $repo_name."
}

change_kernel() {
    clear
    add_exclude_to_updates_repo
    update_kernel
}

stock_kernel() {
    clear
    remove_exclude_from_updates_repo
    remove_copr_repo
}

kernel_menu(){
# Show the dialog menu
while true; do
    action=$(dialog --clear --title "Kernel Management" --menu "Choose an option:" 15 50 2 \
        1 "Change to Nobara fsync kernal" \
        2 "Return to Stock Fedora Kernel" \
        3 "Back" \
        3>&1 1>&2 2>&3)

    case $action in
        1)
            change_kernel
            ;;
        2)
            stock_kernel
            ;;
        3)
            clear
            return 0
            ;;
        *)
            echo "Invalid option."
            ;;
    esac
done
}
